<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Weather App</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.9/css/weather-icons.min.css"/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/>
        
        <!--cusrive-->
        <link href="https://fonts.googleapis.com/css?family=Julius+Sans+One|Open+Sans" rel="stylesheet">
        <!-- sans-serif-->
        <link rel="stylesheet" href="style.css"/>  
    </head>
    <body>
        <h4 id="initialMsg">Loading weather data..</h4>
        <div class="container">
            <div id="weatherDiv" class="centre-block">
                <div id="contentDiv">
                    <div id="headerDiv">
                        <h1>Weather App</h1>
                    </div>
                    <div id="tempDiv">
                        <div id="temp">
                            <span id="curTemp"></span>&nbsp;
                            <a id="tempM"><i class="wi wi-celsius"></i></a>
                        </div>
                        <div id="cityDiv">
                            <strong>|</strong>
                            <span id="city"></span>
                        </div>
                        <div id="searchDiv">
                            <a id="search"><i class="fa fa-search"></i></a>
                        </div>
                    </div>
                    <div id="dateDiv">
                        <span id="day"></span>
                        <strong>,</strong>
                        <span id="date"></span>
                    </div>
                    <div id="iconDiv">
                        <div id="icon">
                            <i class="wi"></i>
                        </div>
                        <div id="status"></div>
                    </div>
                    <!-- forecast div ends here -->
                </div>
                <!-- contentDiv ends here -->
                <div id="detailsDiv">
                    <div id="detailsHeader">
                        <h4>Details <i class="fa fa-caret-down"></i></h4>
                    </div>
                    <div id="details">
                        <div class="parent">
                            <div class="child1">
                                &nbsp;<i class="wi wi-thermometer-exterior"></i>
                                <span>Min Temp</span>
                            </div>
                            <div class="child2">
                                <span id="minTemp"></span>
                                <i class="wi wi-celsius"></i>
                            </div>
                        </div>
                        <div class="parent">
                            <div class="child1">
                                &nbsp;<i class="wi wi-thermometer"></i>
                                <span>Max Temp</span>
                            </div>
                            <div class="child2">
                                <span id="maxTemp"></span>
                                <i class="wi wi-celsius"></i>
                            </div>
                        </div>
                        <div class="parent">
                            <div class="child1">
                                <i class="wi wi-sunrise"></i>
                                <span>Sunrise</span>
                            </div>
                            <div class="child2">
                                <span id="sunrise"></span>
                            </div>
                        </div>
                        <div class="parent">
                            <div class="child1">
                                <i class="wi wi-sunset"></i>
                                <span>Sunset</span>
                            </div>
                            <div class="child2">
                                <span id="sunset"></span>
                            </div>
                        </div>
                        <div class="parent">
                            <div class="child1">
                                <i class="wi wi-sprinkle"></i>
                                <span>Humidity</span>
                            </div>
                            <div class="child2">
                                <span id="humidity"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- detailsDiv end here -->
            </div>
            <!-- weatherDiv ends here -->
        </div>
        <!-- container div ends here-->
        
        <!-- html code ends here, script code starts from here -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        
        <script>
            $(document).ready(function(){
                $("#weatherDiv").css("display","none");
                
                var lat,lon;
                
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition(showPosition,defaultPosition);
                  
                }else{
                    alert("Please update your browser");
                }
                $("#tempM").click(function(){
                    toggleTemp(this);
                });
                $("#search").click(function(){
                    var city = prompt("Enter your city");
                    //hide div & show initialMsg
                    if(city.length>0){
                        //reset temperatures icons to celcius
                        $("i.wi-fahrenheit").attr("class","wi wi-celsius");
                        //hide weatherDiv
                        $("#weatherDiv").css("display","none");
                        //show intermediate message
                        $("#initialMsg").css("display","block");

                        var sUrl = "http://api.openweathermap.org/data/2.5/weather?q="+city+"&appid=db12807ec71a01fd7eccfddb3c657dcb";
                        //make asynchronus API call
                        $.getJSON(sUrl,function(jsonQ){
                            setWeatherData(jsonQ);
                        });
                    }

                    //setDate();
                });
                $("#detailsHeader").click(function(){
                    var display = $("#details").css("display");
                    if(display.indexOf("none") >= 0){ 
                        $("#details").slideDown("slow");
                        $(this).find("i").removeClass("fa-caret-down").addClass("fa-caret-up");
                    }
                    else{  
                        $("#details").slideUp("slow");
                        $(this).find("i").removeClass("fa-caret-up").addClass("fa-caret-down");
                    }
                });
                
            });
            
            function celciusToFahrenheit(temp){
                return Math.round((temp*9)/5+32);
            }
            function defaultPosition(){
                var sUrl = "http://api.openweathermap.org/data/2.5/weather?q=london,uk&appid=db12807ec71a01fd7eccfddb3c657dcb";
                    
                $.getJSON(sUrl,function(jsonQ){
                    setWeatherData(jsonQ);
                });

                //setDate();definition changed
                alert("Location on Chrome browser won't be accurate due to deprecated geoLocation functions");
            }
            function fahrenheitToCelcius(temp){
                return Math.round((temp-32)*5/9);
            }
            function setDate(dt){
                var today = new Date(dt*1000);
                var month = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                var day = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
                $("#day").text(day[today.getDay()]);
                var date = month[today.getMonth()]+"-"+today.getDate()+"-"+today.getFullYear();
                $("#date").text(date);
            }
            function setWeatherData(curWeather){
                
                setDate(curWeather.dt);
                                
                $("#city").text(curWeather.name);
                $("#curTemp").text(Math.round(curWeather.main.temp-273.15));
                $("#minTemp").text(Math.round(curWeather.main.temp_min-273.15));
                $("#maxTemp").text(Math.round(curWeather.main.temp_max-273.15));
                $("#humidity").text(curWeather.main.humidity+"%");
                $("#status").text(curWeather.weather[0].main);
                
                var sunrise = new Date(curWeather.sys.sunrise * 1000);
                var sDate = (sunrise.getHours() +":"+ sunrise.getMinutes() +":"+sunrise.getSeconds());
                $("#sunrise").text(sDate);
                
                var sunset = new Date(curWeather.sys.sunset * 1000);
                sDate = (sunset.getHours() +":"+ sunset.getMinutes() +":"+sunset.getSeconds());
                
                $("#sunset").text(sDate);
                
                // setting icon
                var iconId = curWeather.weather[0].id;
                
                //color pairs (light shade, dark shade) for morning/evening,day, cloudy day & night respectively
                var bgColors = ["#ffe88f","#ffe066","#fff","#cee","#acb4c4","#8d99ae","#3e4053","#000"];                
                var curTime = new Date().getTime();
                sunrise = sunrise.getTime();
                sunset = sunset.getTime();
                
                //remove existing icon
                $("#icon>i").attr("class","");
                //night
                if(curTime < sunrise || curTime > sunset){
                    $("#icon").find("i").addClass("wi wi-owm-night-"+iconId);
                    $("#contentDiv").css("background-color",bgColors[6]);
                    $("#detailsDiv").css("background-color",bgColors[7]);
                    $("#weatherDiv").css("color","#fff");
                }
                //day
                else{
                    $("#weatherDiv").css("color","#000");
                    if(curWeather.weather[0].main !== 'Clear')
                        $("#icon").find("i").addClass("wi wi-owm-day-"+iconId);
                    else
                        $("#icon").find("i").addClass("wi wi-owm-day-"+iconId);
                    //cloudy or raining
                    if(curWeather.weather[0].main.toLowerCase().indexOf("cloud")>=0 || curWeather.weather[0].main.toLowerCase().indexOf("rain")>=0){
                        $("#contentDiv").css("background-color",bgColors[4]);
                        $("#detailsDiv").css("background-color",bgColors[5]);
                        
                    }
                    //clear day
                    else{
                        //morning or evening, diff btw sunrise & sunset is more than 2 hrs and curtime is less
                        // than 2 hrs from sunrise & sunset
                        if(sunset-sunrise> 2*60*60*1000 && (curTime-sunrise < 2*60*60*100 || sunset-curTime < 2*60*60*1000)){
                            $("#contentDiv").css("background-color",bgColors[0]);
                            $("#detailsDiv").css("background-color",bgColors[1]);
                            
                        }
                        //other part of the day
                        else{
                            $("#contentDiv").css("background-color",bgColors[2]);
                            $("#detailsDiv").css("background-color",bgColors[3]);
                        }
                    }
                }
                
                /*
                $("#contentDiv").css("background-color",bgColors[6]);
                $("#detailsDiv").css("background-color",bgColors[7]);
                $("#weatherDiv").css("color","#fff");
                */
                //show content, hide details Div & initialMsg
                $("#weatherDiv").slideDown("slow");
                $("#details,#initialMsg").css("display","none");
                
            }
            function showPosition(position){
                lat = position.coords.latitude;
                lon = position.coords.longitude;
                
                var sUrl = "http://api.openweathermap.org/data/2.5/weather?lat="+lat+"&lon="+lon+"&appid=db12807ec71a01fd7eccfddb3c657dcb";
                    
                $.getJSON(sUrl,function(jsonQ){
                    setWeatherData(jsonQ);
                });

                setDate();
                
            }
            function toggleTemp(obj){
                var iconClass = $(obj).find("i").attr("class");
                var curTemp = $("#curTemp").text();
                var minTemp = $("#minTemp").text();
                var maxTemp = $("#maxTemp").text();
                if(iconClass.indexOf("celsius") >= 0){
                    $("#curTemp").text(celciusToFahrenheit(curTemp));
                    $("#minTemp").text(celciusToFahrenheit(minTemp));
                    $("#maxTemp").text(celciusToFahrenheit(maxTemp));
                    $(document).find("i.wi-celsius").removeClass("wi-celsius").addClass("wi-fahrenheit");
                }
                else{
                    $("#curTemp").text(fahrenheitToCelcius(curTemp));
                    $("#minTemp").text(fahrenheitToCelcius(minTemp));
                    $("#maxTemp").text(fahrenheitToCelcius(maxTemp));
                    $(document).find("i.wi-fahrenheit").removeClass("wi-fahrenheit").addClass("wi-celsius");
                }
            }
        </script>
    </body>
</html>
